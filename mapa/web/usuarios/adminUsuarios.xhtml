<ui:composition template="#{ConfiguracionBean.rutaContexto}resources/Plantillas/normal.xhtml"
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                xmlns:fnc="http://yournamespace.com/fnc">

    <ui:define name="titulo">
        <h:outputText value="Administrar usuarios"/>
    </ui:define>

    <ui:define name="content">
        <h:panelGroup rendered="#{!UserBean.administrarUsuarios}">
            <h:panelGrid width="100%">
                <br/><br/><br/>
                <h:panelGrid style="text-align: center; margin: 0px auto; color: red; font-weight: bold" >
                        <h:outputText value="No tienes permiso para acceder a esta sección"/>
                </h:panelGrid>
            </h:panelGrid>
        </h:panelGroup>
        
        <h:panelGroup rendered="#{UserBean.administrarUsuarios}">
            <h:form>
                <h:panelGrid id="pgUsuarios" columns="2">
                    <h:outputText value="Escoger usuario"/>
                    <h:selectOneMenu value="#{TramiteBean.usuariosBuscar}">
                        <f:selectItems value="#{TramiteBean.listaUsuariosSIUST}"/>
                        <p:ajax update=":pgAdminUsuarios" listener="#{TramiteBean.buscarUsuario}" />
                    </h:selectOneMenu>
                </h:panelGrid>
            </h:form>
            <p:separator/>

            <h:panelGrid id="pgAdminUsuarios" width="100%">
                <h:panelGrid rendered="#{TramiteBean.usuariosEncontrado.codigoSIUST.userCode != null}">
                    <h:panelGrid columns="2">
                        <h:outputText value="Usuario" style="font-weight: bold;"/>
                        <h:outputText value="#{fnc:userEmail(TramiteBean.usuariosEncontrado.codigoSIUST.email)}"/>
                        <h:outputText value="Tipo de usuario" style="font-weight: bold;"/>
                        <h:outputText value="#{TramiteBean.usuariosEncontrado.tunCodigo.tutNombre == null ? 'SIN PERFIL' : TramiteBean.usuariosEncontrado.tunCodigo.tutNombre}" style="font-weight: bold; #{TramiteBean.usuariosEncontrado.tunCodigo.tutNombre == null ? 'color: red;' : 'color: green;'}"/>
                    </h:panelGrid>

                    <h:panelGrid rendered="#{TramiteBean.usuariosEncontrado.tunCodigo.tunCodigo != 1}">
                        <h:form>
                            <p:commandButton type="button" value="Cambiar perfil" onclick="permisosDialog.show();" style="width:120px"/>
                        </h:form>

                        <p:dialog header="Cambiar perfil" widgetVar="permisosDialog" resizable="false" modal="true" draggable="false"
                                  width="200" showEffect="fade" hideEffect="fade" position="center">
                            <h:panelGrid id="datosPermisos" width="100%" style="font-size: 10px;" >
                                <h:form>
                                    <h:panelGrid width="100%"  cellpadding="0" cellspacing="0">
                                        <h:panelGrid columns="2" cellpadding="0" cellspacing="0">
                                            <h:outputText value="Usuario:&#160;" style="font-weight: bold;"/>
                                            <h:outputText value="#{TramiteBean.usuariosEncontrado.codigoSIUST.email}"/>
                                        </h:panelGrid>
                                        <br/>
                                        <h:outputText value="Escoger perfil"/>
                                        <h:selectOneMenu value="#{TramiteBean.usuariosEncontrado.tunCodigo.tunCodigo}">
                                            <f:selectItem itemValue="0" itemLabel="SIN PERFIL" />
                                            <f:selectItem itemValue="2" itemLabel="COORDINADOR"/>
                                            <f:selectItem itemValue="3" itemLabel="ASESOR"/>
                                            <f:selectItem itemValue="4" itemLabel="ASIGNADOR"/>
                                        </h:selectOneMenu>
                                        <br/>
                                    </h:panelGrid>
                                    <h:panelGrid columns="2" width="100%" style="text-align: center;">
                                        <p:commandButton value="Aceptar" action="#{TramiteBean.cambiarPerfil}" update=":datosResultado" oncomplete="permisosDialog.hide();resultadoDialog.show();"/>
                                        <p:commandButton type="button" value="Cancelar" onclick="permisosDialog.hide();"/>
                                    </h:panelGrid>
                                </h:form>
                             </h:panelGrid>
                        </p:dialog>

                        <p:dialog header="Resultado" widgetVar="resultadoDialog" resizable="false" modal="true" draggable="false"
                                  width="400" showEffect="fade" hideEffect="fade" position="center" closable="false">
                            <h:panelGrid id="datosResultado" style="text-align: center; " width="100%">
                                <h:form>
                                    <h:outputText value="#{TramiteBean.mensajeAdminUsuario}" escape="false"/>
                                    <p:commandButton value="Aceptar" onclick="resultadoDialog.hide();" update=":pgAdminUsuarios,:frmListaUsuarios"/>
                                 </h:form>
                            </h:panelGrid>
                        </p:dialog>

                    </h:panelGrid>

                </h:panelGrid>

            </h:panelGrid>

            <h:form id="frmListaUsuarios">
                <h:panelGroup id="pgUsuarios">
                    <p:dataTable id="datos" value="#{TramiteBean.usuariosAplicacion}" var="us"
                                 style="font-size:10px" emptyMessage="No se encontraron usuarios" >
                        <f:facet name="header">Lista de usuarios de la aplicación</f:facet>
                        <p:column headerText="USUARIO" sortBy="#{us.codigoSIUST.email}" style="width:80px; text-align: center;">
                            <h:outputText value="#{fnc:userEmail(us.codigoSIUST.email)}"/>
                        </p:column>
                        <p:column headerText="TIPO DE USUARIO" sortBy="#{us.tunCodigo.tutNombre}" style="width:80px">
                            <h:outputText value="#{us.tunCodigo.tutNombre}"/>
                        </p:column>
                        <p:column headerText="PERMISOS" style="width:80px; text-align: left;">
                            <h:panelGroup rendered="#{us.tunCodigo.tunCodigo == 3}" >
                                <ui:repeat value="#{us.paPermisosAsesorCollection}" var="pa">
                                    <h:outputText value="&#8226; #{pa.ptnCodigo.pttNombre}"/>
                                    <br/>
                                </ui:repeat>
                            </h:panelGroup>
                        </p:column>
                        <p:column style="width:110px; text-align: center;">
                            <p:commandButton rendered="#{us.tunCodigo.tunCodigo == 3}" value="Cambiar permisos" action="#{TramiteBean.mostrarPermisosAsesor}" ajax="false" icon="ui-icon ui-icon-search" onclick="statusDialog.show();">  
                                <f:setPropertyActionListener target="#{TramiteBean.asesorEditar}" value="#{us}"/>  
                            </p:commandButton>  
                        </p:column>
                    </p:dataTable>
                </h:panelGroup>
            </h:form>
            
        </h:panelGroup>
    </ui:define>
</ui:composition>

